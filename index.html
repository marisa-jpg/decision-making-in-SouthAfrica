<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Everyday Planning in South Africa Survey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #FAFAFA;
      --bg-alt: #F5F5F5;
      --primary: #2E7D83;
      --primary-alt: #4A7BA7;
      --button: #3E8E7E;
      --button-alt: #4E9FD8;
      --error: #E57373;
      --alert: #FBC02D;
      --text: #333333;
      --progress1: #B2DFDB;
      --progress2: #26A69A;
      --border: #E0E0E0;
      --radius: 8px;
      --max-width: 650px;
      --spacing: 1.5rem;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .survey-container {
      background: #fff;
      max-width: var(--max-width);
      margin: 2rem auto;
      box-shadow: 0 2px 12px #0001;
      border-radius: var(--radius);
      padding: var(--spacing);
      min-height: 60vh;
    }
    h1, h2 {
      color: var(--primary);
      margin-top: 0;
    }
    .survey-content {
      margin-bottom: var(--spacing);
    }
    .btn-row {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    button, .btn {
      background: var(--button);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      padding: 0.75em 2em;
      font-size: 1.08em;
      cursor: pointer;
      margin: 0.2em 0;
      transition: background 0.18s;
    }
    button.secondary, .btn.secondary {
      background: var(--primary-alt);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    label {
      display: block;
      margin: 1rem 0 0.4rem;
      font-weight: 500;
    }
    input[type="text"], input[type="number"], select, textarea {
      width: 100%;
      padding: 0.5em;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 1em;
      margin-bottom: 1.1rem;
      background: var(--bg-alt);
      color: var(--text);
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.95em;
      color: #888;
      margin: 0.2em 0 0.8em 0;
    }
    .progress-bar-bg {
      width: 100%;
      height: 16px;
      border-radius: 8px;
      background: linear-gradient(to right, var(--progress1), var(--progress2));
      margin: 1em 0;
      position: relative;
      box-shadow: 0 1px 4px #0001 inset;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: var(--primary-alt);
      border-radius: 8px 0 0 8px;
      transition: width 0.4s;
    }
    .timer {
      font-size: 1.09em;
      font-weight: bold;
      color: var(--primary);
      margin: 1em 0 0.5em 0;
    }
    .error-message {
      color: var(--error);
      background: #fff3f3;
      border: 1px solid var(--error);
      border-radius: var(--radius);
      padding: 0.5em 1em;
      margin: 0.5em 0;
      font-size: 1em;
      display: none;
    }
    .alert-message {
      color: #fff;
      background: var(--alert);
      border-radius: var(--radius);
      padding: 0.5em 1em;
      margin: 0.5em 0;
      font-size: 1em;
      display: none;
    }
    .hidden { display: none !important; }
    .multi-select-list label {
      display: flex;
      align-items: center;
      margin-bottom: 0.5em;
    }
    .multi-select-list input[type="checkbox"] { margin-right: 0.5em; }
    .center { text-align: center; }
    @media (max-width: 800px) {
      .survey-container { padding: 1em; max-width: 99vw;}
    }
  </style>
</head>
<body>
  <div class="survey-container">
    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progressBar" style="width: 8%;"></div>
    </div>
    <form id="surveyForm" autocomplete="off">

      <!-- Screen 1: Consent -->
      <div class="survey-screen" id="screen-1">
        <h1>Study on Everyday Planning in South Africa</h1>
        <div class="survey-content">
          <p>Thank you for considering taking part in this study. You’ll complete short tasks about everyday planning and decision-making. Some questions may touch on finances. Your webcam may be used to estimate where you look on the screen (eye position only, no video or images are stored).</p>
          <p>Participation is voluntary and anonymous. You can stop at any time without penalty.</p>
          <p>We really value your voice, this research is about building a South African perspective into how financial planning support can be designed.</p>
          <p class="alert-message" id="ethicsNote" style="display:block;">Ethics Note: Your responses stay fully anonymous, personal info is not linked to your answers.</p>
        </div>
        <div class="btn-row">
          <button type="button" onclick="nextScreen()" id="agreeBtn">I agree (continue to survey)</button>
          <button type="button" class="secondary" onclick="exitSurvey()">I do not agree (exit survey)</button>
        </div>
      </div>

      <!-- Screen 2: Warm-up -->
      <div class="survey-screen hidden" id="screen-2">
        <h2>Warm-up</h2>
        <label>Right now, how stressed do you feel about money?</label>
        <input type="range" min="0" max="100" step="1" name="stressSlider" id="stressSlider" value="50">
        <div class="slider-labels">
          <span>Not at all</span>
          <span>Very stressed</span>
        </div>
        <label>In the past month, how often did you worry about running out of money for basics?</label>
        <select name="worryFrequency" required>
          <option value="">Select...</option>
          <option>Never</option>
          <option>Rarely</option>
          <option>Sometimes</option>
          <option>Often</option>
          <option>Almost always</option>
        </select>
        <label>How confident are you that your income will last to next payment date?</label>
        <select name="incomeConfidence" required>
          <option value="">Select...</option>
          <option>Very confident</option>
          <option>Somewhat confident</option>
          <option>Not so confident</option>
          <option>Not at all</option>
        </select>
        <label>How often did you skip/late pay a bill in the past 30 days?</label>
        <select name="latePayFrequency" required>
          <option value="">Select...</option>
          <option>Never</option>
          <option>Once</option>
          <option>A few times</option>
          <option>Often</option>
          <option>Almost always</option>
        </select>
        <label>How many people do you support financially?</label>
        <input type="number" min="0" max="20" name="supportCount" required>
        <div class="btn-row">
          <button type="button" onclick="nextScreen()">Continue</button>
        </div>
      </div>

      <!-- Screen 3: About you -->
      <div class="survey-screen hidden" id="screen-3">
        <h2>About you</h2>
        <label>Do you live in South Africa?</label>
        <select name="liveInSA" required>
          <option value="">Select...</option>
          <option>Yes</option>
          <option>No</option>
        </select>
        <label>What is your age?</label>
        <input type="number" min="16" max="120" name="age" required>
        <label>What is your gender?</label>
        <select name="gender" required>
          <option value="">Select...</option>
          <option>Male</option>
          <option>Female</option>
          <option>Non-binary / Other</option>
          <option>Prefer not to say</option>
        </select>
        <label>What is the highest level of education you have completed?</label>
        <select name="education" required>
          <option value="">Select...</option>
          <option>No formal education</option>
          <option>Primary school</option>
          <option>Secondary / High school</option>
          <option>Some college or vocational training</option>
          <option>University</option>
        </select>
        <label>Monthly income range:</label>
        <select name="incomeRange" required>
          <option value="">Select...</option>
          <option>Under R4 000</option>
          <option>R4 001 – R10 000</option>
          <option>R10 001 – R20 000</option>
          <option>Above R20 000</option>
        </select>
        <label>What is your main source of household income?</label>
        <select name="incomeSource" required>
          <option value="">Select...</option>
          <option>Formal salary</option>
          <option>Social grant(s)</option>
          <option>Informal work / piece jobs</option>
          <option>Payments from family</option>
          <option>Self-employment / small business</option>
        </select>
        <div class="btn-row">
          <button type="button" onclick="nextScreen()">Continue</button>
        </div>
      </div>

      <!-- Screen 4: Scenario reading with timer and comprehension check -->
      <div class="survey-screen hidden" id="screen-4">
        <h2>Scenario</h2>
        <div class="survey-content">
          <p>Imagine it is four days before payday.<br>
            You have <strong>R300</strong> left in your account.<br>
            In three days, fixed debits are due:
          </p>
          <ul>
            <li>Electricity: R200</li>
            <li>Transport: R120</li>
          </ul>
          <p>This morning, your child’s school sent an urgent message:<br>
            School supplies (exam materials + uniform repairs) costing <strong>R500</strong> are needed within 48 hours.
          </p>
          <p>You cannot borrow from family. Your overdraft is maxed out.</p>
          <p>How will you manage the next four days so that the school is paid and your essential expenses are covered?</p>
        </div>
        <div class="timer" id="timer4">Reading time: <span id="timer4-count">20</span>s</div>
        <fieldset id="comprehensionCheck" disabled>
          <label>How much is available in your account now?</label>
          <select id="compQ1" required>
            <option value="">Select...</option>
            <option>R300</option>
            <option>R500</option>
            <option>R0</option>
          </select>
          <label>When are the school costs due?</label>
          <select id="compQ2" required>
            <option value="">Select...</option>
            <option>Within 48 hours</option>
            <option>In two weeks</option>
            <option>Next month</option>
          </select>
          <span class="error-message" id="compError">Please select the correct answers to proceed.</span>
        </fieldset>
        <div class="btn-row">
          <button type="button" id="compContinue" onclick="checkComprehension()" disabled>Continue</button>
        </div>
      </div>

      <!-- Screen 5: Option Generation with countdown -->
      <div class="survey-screen hidden" id="screen-5">
        <h2>Option Generation</h2>
        <p>In 30 seconds, list as many specific actions as you could take to handle the situation.<br>
          Write one action per line (e.g., ‘sell [item] for about R___’, ‘delay electricity by ___ days’, ‘buy partial supplies now’).
        </p>
        <textarea name="actionList" id="actionList" required placeholder="Enter actions here..."></textarea>
        <div class="timer" id="timer5">Time remaining: <span id="timer5-count">30</span>s</div>
        <div class="btn-row">
          <button type="button" id="optGenContinue" onclick="nextScreen()" disabled>Continue</button>
        </div>
      </div>

      <!-- Screen 6: Prioritisation -->
      <div class="survey-screen hidden" id="screen-6">
        <h2>Prioritise Your Actions</h2>
        <p>From your list, select the top two actions you’d try first.</p>
        <div id="actionSelectList" class="multi-select-list"></div>
        <label>Briefly explain why these two.</label>
        <textarea name="prioritiseReason" maxlength="300" required></textarea>
        <div class="btn-row">
          <button type="button" onclick="nextScreen()">Continue</button>
        </div>
      </div>

      <!-- Screen 7: Immediate Scarcity & Checks -->
      <div class="survey-screen hidden" id="screen-7">
        <h2>Quick Check-in</h2>
        <label>Right now I feel financially squeezed</label>
        <select name="scarcityFeel" required>
          <option value="">Select...</option>
          <option>Yes</option>
          <option>Sort of</option>
          <option>Not at all</option>
        </select>
        <label>I feel in control of my money situation right now.</label>
        <select name="controlFeel" required>
          <option value="">Select...</option>
          <option>Yes</option>
          <option>Sort of</option>
          <option>Not at all</option>
        </select>
        <label>I could cover a R2000 expense in the next 48 hours without missing essentials.</label>
        <select name="liquidityFeel" required>
          <option value="">Select...</option>
          <option>Yes</option>
          <option>No</option>
        </select>
        <label>To show you are paying attention, please select ‘Agree’ on this item.</label>
        <select name="attentionCheck" required>
          <option value="">Select...</option>
          <option>Agree</option>
          <option>Disagree</option>
        </select>
        <div class="btn-row">
          <button type="button" onclick="nextScreen()">Continue</button>
        </div>
      </div>

      <!-- Screen 8: Split-Payout Framing -->
      <div class="survey-screen hidden" id="screen-8">
        <h2>Split-Payout Framing</h2>
        <div class="survey-content">
          <p>Imagine a system designed not to restrict you, but to support your financial decisions and help you ensure essentials are covered throughout the month. This approach, called "income smoothing," means your monthly income is split into two equal payouts: one now, and one in two weeks. Essential payments (like electricity and transport) are automatically set aside from each payout, so you don’t have to worry about missing them. The rest of your money is yours to use as you choose, and your balance refreshes mid-month.</p>
          <p>This method isn’t about limiting your choices or suggesting you can’t manage your money. Instead, it’s about helping you overcome common patterns or habits that can make it hard to stick to your plans, especially with all the pressures of daily life. By smoothing out your income, the system helps you avoid automatic or impulsive decisions, making it easier to achieve the financial outcomes you want.</p>
        </div>
        <label>Would having your income paid in two parts help you avoid impulsive spending or make it easier to control your financial choices throughout the month?</label>
        <select required>
          <option value="">Select...</option>
          <option>Yes, it would help a lot</option>
          <option>Somewhat, it might help</option>
          <option>It would make no difference</option>
          <option>It would make things much harder</option>
        </select>
        <label>Do you think this solution would help you avoid last-minute or impulsive financial decisions, for example, spending too much at the start of the month?</label>
        <select required>
          <option value="">Select...</option>
          <option>Yes definitely</option>
          <option>Maybe</option>
          <option>Probably not</option>
          <option>Not at all</option>
        </select>
        <label>Do you think that splitting your income this way would reduce the stress you feel when planning your spending?</label>
        <select required>
          <option value="">Select...</option>
          <option>Yes it would help</option>
          <option>Only a little</option>
          <option>No change</option>
          <option>Not at all</option>
        </select>
        <label>Does having essential expenses (like electricity and transport) automatically covered make decision-making easier for you, or does it make you feel less in control?</label>
        <select required>
          <option value="">Select...</option>
          <option>Much easier</option>
          <option>Only a little</option>
          <option>No change</option>
          <option>Not at all</option>
        </select>
        <label>If you were to use this system, which essential categories would you want to be automatically protected every payout? E.g. Food, airtime, transport, school fees</label>
        <input type="text" required>
        <div class="btn-row">
          <button type="button" onclick="nextScreen()">Continue</button>
        </div>
      </div>

      <!-- Screen 9: Envelope/Default Budgeting -->
      <div class="survey-screen hidden" id="screen-9">
        <h2>Envelope/Default Budgeting</h2>
        <div class="survey-content">
          <p>Imagine a budgeting tool designed to support your financial planning by helping you set aside money for your most important needs. This tool starts by suggesting default amounts for key categories, like food, electricity, transport, and other essentials, based on what’s typical for households like yours. You can change these amounts to fit your own situation, and if you want to reduce the amount set aside for essentials, you’ll be asked to briefly explain your choice.</p>
          <p>You also have the option to “lock” a portion of your budget for release in the middle of the month. This isn’t about limiting your freedom, but about making it easier to stick to your plans and avoid common habits or temptations that can throw off your budget. The aim is to help you make sure your essentials are always covered, even if something unexpected comes up.</p>
        </div>
        <label>I felt in control of my choices while using this budgeting tool.</label>
        <select required>
          <option value="">Select...</option>
          <option>Strongly disagree</option>
          <option>Disagree</option>
          <option>Neutral</option>
          <option>Agree</option>
          <option>Strongly agree</option>
        </select>
        <label>This tool made me think carefully about my decisions.</label>
        <select required>
          <option value="">Select...</option>
          <option>Strongly disagree</option>
          <option>Disagree</option>
          <option>Neutral</option>
          <option>Agree</option>
          <option>Strongly agree</option>
        </select>
        <label>I feel confident about the decisions I made with this tool.</label>
        <select required>
          <option value="">Select...</option>
          <option>Strongly disagree</option>
          <option>Disagree</option>
          <option>Neutral</option>
          <option>Agree</option>
          <option>Strongly agree</option>
        </select>
        <div class="btn-row">
          <button type="button" onclick="nextScreen()">Continue</button>
        </div>
      </div>

      <!-- Screen 10: Commitment Device / Goal Shield -->
      <div class="survey-screen hidden" id="screen-10">
        <h2>Commitment Device / Goal Shield</h2>
        <div class="survey-content">
          <p>Imagine you have the option to “shield” a small amount of money (for example, R60) for a period of 10 days. This money can only be used after that period or for specific pre-approved expenses, like food or electricity. You can cancel the shield and access the funds at any time, but you’ll see a reminder of your original savings goal before doing so. This feature is designed to help protect your savings from immediate temptations and support your longer-term financial goals.</p>
        </div>
        <label>Would having the option to set aside (“shield”) a small amount of money for future use help you avoid spending on immediate temptations or help you stick to your financial goals?</label>
        <select required>
          <option value="">Select...</option>
          <option>Yes it would help</option>
          <option>Only a little</option>
          <option>No change</option>
          <option>Not at all</option>
        </select>
        <label>Do you think having a protected savings amount for a set period (e.g., 10 days), with reminders of your goal, would reduce the mental effort or stress of managing your money?</label>
        <select required>
          <option value="">Select...</option>
          <option>Yes it would help</option>
          <option>Only a little</option>
          <option>No change</option>
          <option>Not at all</option>
        </select>
        <label>Does being able to set and adjust your own protected amount make you feel more in control of your budgeting decisions, or less in control because of the automated reminders and restrictions?</label>
        <select required>
          <option value="">Select...</option>
          <option>Much more in control</option>
          <option>Only a little</option>
          <option>A little less in control</option>
          <option>Much less in control</option>
        </select>
        <label>If you were to use this system, what types of expenses or goals would you most want to protect with a shield?</label>
        <input type="text" required>
        <div class="btn-row">
          <button type="button" onclick="nextScreen()">Continue</button>
        </div>
      </div>

      <!-- Screen 11: Debrief & Distress Check -->
      <div class="survey-screen hidden" id="screen-11">
        <h2>Debrief & Distress Check</h2>
        <label>Did any part of the scenario make you uncomfortable?</label>
        <select name="distress" id="distressSelect" required>
          <option value="">Select...</option>
          <option>Yes</option>
          <option>No</option>
        </select>
        <div id="distressExplainDiv" class="hidden">
          <label>Please briefly tell us which part:</label>
          <textarea name="distressExplain" id="distressExplain" maxlength="200"></textarea>
          <a href="https://www.sadag.org/" target="_blank" style="display:block;margin:0.5em 0 1em 0;color:#2E7D83;">Support resources: South African Depression & Anxiety Group</a>
        </div>
        <div class="survey-content">
          <p>Earlier, you read a scenario designed to make budget constraints feel vivid and we then provided you with a few scenarios that would possibly help alleviate this stress. This helps us study how the effects of financial stress may affect decision making and to begin to design possible solutions. <br>
            Your responses are confidential, thank you for taking part in the survey.</p>
        </div>
        <div class="btn-row">
          <button type="button" onclick="nextScreen()">Continue</button>
        </div>
      </div>

      <!-- Screen 12: End of Survey -->
      <div class="survey-screen hidden" id="screen-12">
        <h2>End of Survey</h2>
        <p>Thank you for completing the study!</p>
        <p>Your answers will help researchers understand how South Africans plan and make financial decisions under everyday pressures. This evidence can guide the design of better tools, products, and support systems that reflect the real challenges South African households face.</p>
      </div>
    </form>
    <div class="center hidden" id="exitMsg">
      <h2>Thank you for your interest</h2>
      <p>You have exited the survey. No data has been saved.</p>
    </div>
  </div>

<script>
const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxryXoBL1afE9mkTPby5oHlM4Aja0i-ksu3m2Ev97r7qBpovdITDKTaREIB82_VCj_Q0A/exec';

let currentScreen = 1;
const totalScreens = 12;
let actionLines = [];
let timer4Interval = null;
let timer5Interval = null;

function showScreen(n) {
  document.querySelectorAll('.survey-screen').forEach(el => el.classList.add('hidden'));
  const screen = document.getElementById('screen-' + n);
  if (screen) screen.classList.remove('hidden');
  document.getElementById('progressBar').style.width = (n*100/totalScreens) + "%";
  currentScreen = n;
  if (n === 4) startTimer4();
  if (n === 5) startTimer5();
  if (n === 6) updateActionSelection();
  if (n === 12) {
    submitSurvey();
  }
}

function nextScreen() {
  if (currentScreen === 4) {
    if (!compCheckPassed()) {
      document.getElementById('compError').style.display = "block";
      return;
    }
  }
  if (currentScreen === 5) {
    let val = document.getElementById('actionList').value.trim();
    actionLines = val.split('\n').map(l=>l.trim()).filter(l=>l);
  }
  if (currentScreen < totalScreens) showScreen(currentScreen+1);
}

function exitSurvey() {
  document.getElementById('surveyForm').classList.add('hidden');
  document.getElementById('exitMsg').classList.remove('hidden');
}

function startTimer4() {
  if (timer4Interval) clearInterval(timer4Interval);
  let s = 20;
  document.getElementById('timer4-count').textContent = s;
  document.getElementById('comprehensionCheck').disabled = true;
  document.getElementById('compContinue').disabled = true;
  document.getElementById('timer4').innerHTML = `Reading time: <span id="timer4-count">${s}</span>s`;
  timer4Interval = setInterval(()=>{
    s--;
    document.getElementById('timer4-count').textContent = s;
    if (s <= 0) {
      clearInterval(timer4Interval);
      document.getElementById('timer4').textContent = "You may now answer the comprehension check.";
      document.getElementById('comprehensionCheck').disabled = false;
      document.getElementById('compContinue').disabled = false;
    }
  }, 1000);
}

function startTimer5() {
  if (timer5Interval) clearInterval(timer5Interval);
  let s = 30;
  document.getElementById('timer5-count').textContent = s;
  document.getElementById('optGenContinue').disabled = true;
  document.getElementById('timer5').innerHTML = `Time remaining: <span id="timer5-count">${s}</span>s`;
  timer5Interval = setInterval(()=>{
    s--;
    document.getElementById('timer5-count').textContent = s;
    if (s <= 0) {
      clearInterval(timer5Interval);
      document.getElementById('optGenContinue').disabled = false;
      document.getElementById('timer5').textContent = "You may now continue.";
    }
  }, 1000);
}

function compCheckPassed() {
  let q1 = document.getElementById('compQ1').value, q2 = document.getElementById('compQ2').value;
  return q1 === "R300" && q2 === "Within 48 hours";
}

function checkComprehension() {
  if (compCheckPassed()) {
    document.getElementById('compError').style.display = "none";
    nextScreen();
  } else {
    document.getElementById('compError').style.display = "block";
  }
}

function updateActionSelection() {
  let list = document.getElementById('actionSelectList');
  if (!list) return;
  list.innerHTML = '';
  actionLines.forEach((line,i) => {
    let id = "actionBox"+i;
    let lbl = document.createElement('label');
    lbl.innerHTML = `<input type="checkbox" value="${i}" id="${id}">${line}`;
    list.appendChild(lbl);
  });
  document.querySelectorAll('#actionSelectList input[type=checkbox]').forEach(cb => {
    cb.onclick = function() {
      let boxes = document.querySelectorAll('#actionSelectList input[type=checkbox]:checked');
      if (boxes.length > 2) this.checked = false;
    };
  });
}

function collectSurveyData() {
  const form = document.getElementById('surveyForm');
  const data = {};

  data.stressSlider = form.stressSlider.value;
  data.worryFrequency = form.worryFrequency.value;
  data.incomeConfidence = form.incomeConfidence.value;
  data.latePayFrequency = form.latePayFrequency.value;
  data.supportCount = form.supportCount.value;

  data.liveInSA = form.liveInSA.value;
  data.age = form.age.value;
  data.gender = form.gender.value;
  data.education = form.education.value;
  data.incomeRange = form.incomeRange.value;
  data.incomeSource = form.incomeSource.value;

  data.compQ1 = document.getElementById('compQ1').value;
  data.compQ2 = document.getElementById('compQ2').value;

  data.actionList = form.actionList.value;

  let selected = [];
  document.querySelectorAll('#actionSelectList input[type=checkbox]:checked').forEach(cb => {
    selected.push(cb.parentNode.textContent.trim());
  });
  data.selectedActions = selected.join(' | ');
  data.prioritiseReason = form.prioritiseReason.value;

  data.scarcityFeel = form.scarcityFeel.value;
  data.controlFeel = form.controlFeel.value;
  data.liquidityFeel = form.liquidityFeel.value;
  data.attentionCheck = form.attentionCheck.value;

  let splitFraming = document.querySelectorAll('#screen-8 select');
  data.splitPayoutFraming1 = splitFraming[0]?.value;
  data.splitPayoutFraming2 = splitFraming[1]?.value;
  data.splitPayoutFraming3 = splitFraming[2]?.value;
  data.splitPayoutFraming4 = splitFraming[3]?.value;
  data.essentialCategories = document.querySelector('#screen-8 input[type=text]')?.value;

  let envelopeQs = document.querySelectorAll('#screen-9 select');
  data.envelopeBudgeting1 = envelopeQs[0]?.value;
  data.envelopeBudgeting2 = envelopeQs[1]?.value;
  data.envelopeBudgeting3 = envelopeQs[2]?.value;

  let shieldQs = document.querySelectorAll('#screen-10 select');
  data.commitmentDevice1 = shieldQs[0]?.value;
  data.commitmentDevice2 = shieldQs[1]?.value;
  data.commitmentDevice3 = shieldQs[2]?.value;
  data.shieldGoals = document.querySelector('#screen-10 input[type=text]')?.value;

  data.distress = form.distress?.value;
  data.distressExplain = form.distressExplain?.value;

  return data;
}

function submitSurvey(partial = false) {
  const data = collectSurveyData();
  if (partial) {
    data.partial = true;
    data.consent = false;
  } else {
    data.consent = true;
  }
  fetch(ENDPOINT_URL, {
    method: "POST",
    body: JSON.stringify(data),
    headers: {"Content-Type": "application/json"}
  })
  .then(res => res.json())
  .then(res => {
    if (!partial) alert("Survey submitted! Thank you.");
  })
  .catch(err => {
    if (!partial) alert("Sorry, there was a problem submitting your survey.");
    console.error(err);
  });
}

function submitPartialSurveyOnExit() {
  const data = collectSurveyData();
  data.partial = true;
  data.timestamp = new Date().toISOString();
  data.screenWhenExited = currentScreen;
  if (currentScreen > 1 && navigator.sendBeacon) {
    const blob = new Blob([JSON.stringify(data)], {type : 'application/json'});
    navigator.sendBeacon(ENDPOINT_URL, blob);
  }
}

window.addEventListener("beforeunload", submitPartialSurveyOnExit);

document.addEventListener('DOMContentLoaded', function() {
  showScreen(1);
  document.getElementById('distressSelect').addEventListener('change', function() {
    let v = this.value;
    document.getElementById('distressExplainDiv').classList.toggle('hidden', v !== 'Yes');
    document.getElementById('distressExplain').required = v === 'Yes';
  });
});
</script>
  
</body>
</html>
