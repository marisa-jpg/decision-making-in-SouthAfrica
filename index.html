<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Perceptions of Financial System Safety</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #FAFAFA;
      --bg-alt: #F5F5F5;
      --primary: #2E7D83;
      --primary-alt: #4A7BA7;
      --button: #3E8E7E;
      --button-alt: #4E9FD8;
      --error: #E57373;
      --alert: #FBC02D;
      --text: #333333;
      --progress1: #B2DFDB;
      --progress2: #26A69A;
      --border: #E0E0E0;
      --radius: 8px;
      --max-width: 650px;
      --spacing: 1.5rem;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    .survey-container {
      background: #fff;
      max-width: var(--max-width);
      margin: 2rem auto;
      box-shadow: 0 2px 12px #0001;
      border-radius: var(--radius);
      padding: var(--spacing);
      min-height: 60vh;
    }
    h1, h2 {
      color: var(--primary);
      margin-top: 0;
    }
    .survey-content {
      margin-bottom: var(--spacing);
    }
    .btn-row {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }
    button, .btn {
      background: var(--button);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      padding: 0.75em 2em;
      font-size: 1.08em;
      cursor: pointer;
      margin: 0.2em 0;
      transition: background 0.18s;
    }
    button.secondary, .btn.secondary {
      background: var(--primary-alt);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    label {
      display: block;
      margin: 1rem 0 0.4rem;
      font-weight: 500;
    }
    input[type="text"], input[type="number"], input[type="tel"], select, textarea {
      width: 100%;
      padding: 0.5em;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 1em;
      margin-bottom: 1.1rem;
      background: var(--bg-alt);
      color: var(--text);
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    .small-note {
      font-size: 0.92rem;
      color: #666;
      margin-top: 0.25rem;
      margin-bottom: 0.6rem;
    }
    .slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.95em;
      color: #888;
      margin: 0.2em 0 0.8em 0;
    }
    .progress-bar-bg {
      width: 100%;
      height: 16px;
      border-radius: 8px;
      background: linear-gradient(to right, var(--progress1), var(--progress2));
      margin: 1em 0;
      position: relative;
      box-shadow: 0 1px 4px #0001 inset;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: var(--primary-alt);
      border-radius: 8px 0 0 8px;
      transition: width 0.4s;
    }
    .timer {
      font-size: 1.09em;
      font-weight: bold;
      color: var(--primary);
      margin: 1em 0 0.5em 0;
    }
    .error-message {
      color: var(--error);
      background: #fff3f3;
      border: 1px solid var(--error);
      border-radius: var(--radius);
      padding: 0.5em 1em;
      margin: 0.5em 0;
      font-size: 1em;
      display: none;
    }
    .alert-message {
      color: #fff;
      background: var(--alert);
      border-radius: var(--radius);
      padding: 0.5em 1em;
      margin: 0.5em 0;
      font-size: 1em;
      display: none;
    }
    .hidden { display: none !important; }
    .multi-select-list label {
      display: flex;
      align-items: center;
      margin-bottom: 0.5em;
    }
    .multi-select-list input[type="checkbox"] { margin-right: 0.5em; }
    .center { text-align: center; }

    /* Slider styles */
    .slider-row {
      margin: 0.6rem 0 1.2rem;
    }
    input[type="range"]{
      display: block;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      margin: 0.4rem 0 0.4rem;
      -webkit-appearance: none;
      background: transparent;
      height: 10px;
      border-radius: 6px;
      outline: none;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height: 10px;
      border-radius: 6px;
      background: linear-gradient(to right, var(--progress1), var(--progress2));
    }
    input[type="range"]::-moz-range-track{
      height: 10px;
      border-radius: 6px;
      background: linear-gradient(to right, var(--progress1), var(--progress2));
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance: none;
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--primary-alt);
      box-shadow: 0 0 0 2px #fff, 0 0 0 3px var(--primary-alt);
      cursor: pointer;
      margin-top: -4px;
    }
    input[type="range"]::-moz-range-thumb{
      width: 18px; height: 18px; border-radius: 50%;
      background: var(--primary-alt);
      border: 3px solid #fff;
      box-shadow: 0 0 0 1px var(--primary-alt);
      cursor: pointer;
    }
    .tick-row {
      display: flex;
      justify-content: space-between;
      margin-top: 0.25rem;
      font-size: 0.92rem;
      color: #666;
      user-select: none;
    }
    .tick-row span {
      width: calc(100% / 7);
      text-align: center;
      transform: translateX(0);
    }
    .slider-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.98rem;
    }
    .value-bubble {
      background: var(--primary);
      color: #fff;
      padding: 0.15em 0.5em;
      border-radius: 999px;
      font-weight: 600;
      min-width: 28px;
      text-align: center;
    }

    .support-link {
      display: inline-block;
      margin-top: 0.5rem;
      color: var(--primary);
      text-decoration: none;
    }

    @media (max-width: 800px) {
      .survey-container { padding: 1em; max-width: 99vw;}
      .tick-row span { font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <div class="survey-container">
    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progressBar" style="width: 0%;"></div>
    </div>

    <form id="surveyForm" autocomplete="off">
      <!-- Screen 1: Intro / Consent -->
      <div class="survey-screen" id="screen-1" data-screen-index="1">
        <h1>Perceptions of Financial System Safety</h1>
        <div class="survey-content">
          <p>This short survey asks about your views of different ways of keeping or saving money.</p>
          <p>It should take less than 2 minutes. All answers are anonymous, please respond honestly.</p>
          <p class="small-note">Scale reminder: 1 = Strongly Disagree &nbsp;&nbsp; 7 = Strongly Agree</p>
        </div>
        <div class="btn-row">
          <button type="button" onclick="nextScreen()" id="agreeBtn">Start survey</button>
          <button type="button" class="secondary" onclick="exitSurvey()">Exit</button>
        </div>
      </div>

      <!-- Qualifying question will be inserted dynamically (see script) -->

      <!-- Additional screens are built dynamically -->
    </form>

    <div class="center hidden" id="exitMsg">
      <h2>Thank you</h2>
      <p>Your responses have been recorded. Thank you for taking part in this short survey.</p>
    </div>

    <div class="center hidden" id="ineligibleMsg">
      <h2>Not eligible</h2>
      <p>This survey is for people who live in South Africa and who know what a Stokvel and mashonisas are. Thank you for your interest.</p>
    </div>
  </div>

<script>
const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycbxJHFDlPKeEPZegNiyVoA7WQvBIAfQhV0fjuxtbmEXCj7z0kGTornN_d7xZCQB2gLv6IQ/exec';

// The statements are used directly as the main heading on each statement screen.
// Each statement screen now also displays "1 = Strongly Disagree 7 = Strongly Agree" under the heading.
const statements = [
  "I believe my money is safe in this system.",
  "I understand how this system works.",
  "I trust this system to return my money when I need it.",
  "If something goes wrong, I know how to resolve it.",
  "I feel in control when using this system.",
  "I believe people like me use this system safely.",
  "I would recommend this system to someone else."
];
const systems = [
  { key: "bank", label: "Bank" },
  { key: "stokvel", label: "Stokvel (community saving group)" },
  { key: "mashonisa", label: "Mashonisa (informal money lender)" }
];

let totalScreens = 1; // intro counts as 1
let currentScreen = 1;

function createQualifyingScreen() {
  const form = document.getElementById('surveyForm');
  const screenIndex = ++totalScreens;
  const screenDiv = document.createElement('div');
  screenDiv.className = 'survey-screen hidden';
  screenDiv.id = 'screen-' + screenIndex;
  screenDiv.setAttribute('data-screen-index', screenIndex);

  const h = document.createElement('h2');
  h.innerText = 'Eligibility';
  screenDiv.appendChild(h);

  const content = document.createElement('div');
  content.className = 'survey-content';
  const p = document.createElement('p');
  p.innerText = 'Do you live in South Africa and do you know what a Stokvel and mashonisas are?';
  content.appendChild(p);

  const listDiv = document.createElement('div');
  listDiv.className = 'multi-select-list';
  ['Yes','No'].forEach((opt,i) => {
    const lab = document.createElement('label');
    const radio = document.createElement('input');
    radio.type = 'radio';
    radio.name = 'qualifySA';
    radio.value = opt;
    if (i === 0) radio.required = true;
    lab.appendChild(radio);
    lab.appendChild(document.createTextNode(' ' + opt));
    listDiv.appendChild(lab);
  });
  content.appendChild(listDiv);

  screenDiv.appendChild(content);

  const btnRow = document.createElement('div');
  btnRow.className = 'btn-row';

  const backBtn = document.createElement('button');
  backBtn.type = 'button';
  backBtn.className = 'secondary';
  backBtn.innerText = 'Back';
  backBtn.onclick = function() { showScreen(screenIndex - 1); };
  btnRow.appendChild(backBtn);

  const nextBtn = document.createElement('button');
  nextBtn.type = 'button';
  nextBtn.innerText = 'Next';
  nextBtn.onclick = function() {
    const sel = document.querySelector('input[name="qualifySA"]:checked');
    if (!sel) {
      alert('Please answer the qualifying question to continue.');
      return;
    }
    if (sel.value === 'Yes') {
      nextScreen();
    } else {
      // not eligible -> show an ineligible message and stop
      document.getElementById('surveyForm').classList.add('hidden');
      document.getElementById('ineligibleMsg').classList.remove('hidden');
      // send partial/eligibility record if desired (optional)
      submitPartialEligibility();
    }
  };
  btnRow.appendChild(nextBtn);

  screenDiv.appendChild(btnRow);

  form.appendChild(screenDiv);
}

function submitPartialEligibility() {
  // optionally record that someone started but is ineligible; uses beacon if available
  const data = {
    timestamp: new Date().toISOString(),
    partial: true,
    reason: 'ineligible_qualifying_question',
    screenWhenExited: currentScreen
  };
  if (navigator.sendBeacon) {
    const body = new URLSearchParams(data).toString();
    const blob = new Blob([body], { type: "application/x-www-form-urlencoded" });
    navigator.sendBeacon(ENDPOINT_URL, blob);
  } else {
    // best-effort fetch fallback (not blocking)
    fetch(ENDPOINT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams(data).toString()
    }).catch(()=>{});
  }
}

function createStatementScreens() {
  const form = document.getElementById('surveyForm');

  // For each statement create its own screen (Start index at 2+ depending on qualifying screen)
  statements.forEach((stmt, idx) => {
    const screenIndex = ++totalScreens;
    const screenDiv = document.createElement('div');
    screenDiv.className = 'survey-screen hidden';
    screenDiv.id = 'screen-' + screenIndex;
    screenDiv.setAttribute('data-screen-index', screenIndex);

    // Use the full statement as the heading (no "Statement X" headline)
    const h = document.createElement('h2');
    h.innerText = stmt;
    screenDiv.appendChild(h);

    // Add scale reminder under the heading for each statement screen
    const scaleNote = document.createElement('div');
    scaleNote.className = 'small-note';
    scaleNote.innerText = '1 = Strongly Disagree   7 = Strongly Agree';
    screenDiv.appendChild(scaleNote);

    const content = document.createElement('div');
    content.className = 'survey-content';

    // Sliders for each system
    systems.forEach(sys => {
      const row = document.createElement('div');
      row.className = 'slider-row';
      const label = document.createElement('div');
      label.className = 'slider-label';
      const left = document.createElement('div');
      left.innerText = sys.label;
      const valueBubble = document.createElement('div');
      valueBubble.className = 'value-bubble';
      valueBubble.id = `value_${idx+1}_${sys.key}`;
      valueBubble.innerText = '4'; // default

      label.appendChild(left);
      label.appendChild(valueBubble);
      row.appendChild(label);

      const input = document.createElement('input');
      input.type = 'range';
      input.min = '1';
      input.max = '7';
      input.step = '1';
      input.value = '4';
      input.id = `q${idx+1}_${sys.key}`;
      input.name = `q${idx+1}_${sys.key}`;
      if (sys.key === systems[0].key) input.required = true;

      input.addEventListener('input', function() {
        document.getElementById(valueBubble.id).innerText = this.value;
      });

      row.appendChild(input);

      // numeric ticks 1..7
      const ticks = document.createElement('div');
      ticks.className = 'tick-row';
      for (let t=1; t<=7; t++) {
        const span = document.createElement('span');
        span.innerText = t;
        ticks.appendChild(span);
      }
      row.appendChild(ticks);
      content.appendChild(row);
    });

    screenDiv.appendChild(content);

    // navigation buttons (Back, Next)
    const btnRow = document.createElement('div');
    btnRow.className = 'btn-row';

    const backBtn = document.createElement('button');
    backBtn.type = 'button';
    backBtn.className = 'secondary';
    backBtn.innerText = 'Back';
    backBtn.onclick = function() { showScreen(screenIndex - 1); };
    btnRow.appendChild(backBtn);

    const nextBtn = document.createElement('button');
    nextBtn.type = 'button';
    nextBtn.innerText = 'Next';
    nextBtn.onclick = function() { nextScreen(); };
    btnRow.appendChild(nextBtn);

    screenDiv.appendChild(btnRow);

    form.appendChild(screenDiv);

    // Insert an attention check immediately after the target statement.
    // The target statement is the one about "I believe people like me use this system ..."
    // which is statements[5] (0-based index 5). Place the attention check right after it.
    if (idx === 5) {
      const attnIndex = ++totalScreens;
      const attnDiv = document.createElement('div');
      attnDiv.className = 'survey-screen hidden';
      attnDiv.id = 'screen-' + attnIndex;
      attnDiv.setAttribute('data-screen-index', attnIndex);

      const hAttn = document.createElement('h2');
      hAttn.innerText = 'Attention check';
      attnDiv.appendChild(hAttn);

      const contentAttn = document.createElement('div');
      contentAttn.className = 'survey-content';
      const pAttn = document.createElement('p');
      pAttn.innerText = "Please select \"Agree\" for this question to confirm you're paying attention.";
      contentAttn.appendChild(pAttn);

      const listDiv = document.createElement('div');
      listDiv.className = 'multi-select-list';

      const attnOptions = [
        'Strongly Disagree',
        'Disagree',
        'Agree',
        'Strongly Agree'
      ];
      attnOptions.forEach((opt, i) => {
        const lab = document.createElement('label');
        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'attentionCheck';
        radio.value = opt;
        lab.appendChild(radio);
        // removed the "✅ (correct answer)" text per request
        const labelText = (opt === 'Agree') ? ' Agree' : ' ' + opt;
        lab.appendChild(document.createTextNode(labelText));
        listDiv.appendChild(lab);
      });

      contentAttn.appendChild(listDiv);
      attnDiv.appendChild(contentAttn);

      const btnRowAttn = document.createElement('div');
      btnRowAttn.className = 'btn-row';

      const backBtnAttn = document.createElement('button');
      backBtnAttn.type = 'button';
      backBtnAttn.className = 'secondary';
      backBtnAttn.innerText = 'Back';
      backBtnAttn.onclick = function() { showScreen(attnIndex - 1); };
      btnRowAttn.appendChild(backBtnAttn);

      const nextBtnAttn = document.createElement('button');
      nextBtnAttn.type = 'button';
      nextBtnAttn.innerText = 'Next';
      nextBtnAttn.onclick = function() {
        const sel = document.querySelector('input[name="attentionCheck"]:checked');
        if (!sel) {
          alert('Please answer the attention check.');
          return;
        }
        if (sel.value !== 'Agree') {
          alert('Please select "Agree" to continue.');
          return;
        }
        nextScreen();
      };
      btnRowAttn.appendChild(nextBtnAttn);

      attnDiv.appendChild(btnRowAttn);
      form.appendChild(attnDiv);
    }

  });
}

function createScarcityScreen() {
  const form = document.getElementById('surveyForm');
  const screenIndex = ++totalScreens;
  const screenDiv = document.createElement('div');
  screenDiv.className = 'survey-screen hidden';
  screenDiv.id = 'screen-' + screenIndex;
  screenDiv.setAttribute('data-screen-index', screenIndex);

  const h = document.createElement('h2');
  h.innerText = 'Scarcity prime';
  screenDiv.appendChild(h);

  const content = document.createElement('div');
  content.className = 'survey-content';
  const p = document.createElement('p');
  // made the requested portion bold
  p.innerHTML = 'Imagine: You have <strong>R250 to last the next 7 days</strong>, and you are unsure when your next income will arrive. How would this situation make you feel when deciding where to ke[...]';
  content.appendChild(p);

  const options = [
    'Very stressed',
    'Somewhat stressed',
    'Neutral',
    'Somewhat calm',
    'Very calm'
  ];
  const listDiv = document.createElement('div');
  listDiv.className = 'multi-select-list';
  options.forEach((opt,i) => {
    const lab = document.createElement('label');
    const radio = document.createElement('input');
    radio.type = 'radio';
    radio.name = 'scarcityPrime';
    radio.value = opt;
    if (i === 0) radio.required = true;
    lab.appendChild(radio);
    lab.appendChild(document.createTextNode(' ' + opt));
    listDiv.appendChild(lab);
  });
  content.appendChild(listDiv);

  screenDiv.appendChild(content);

  const btnRow = document.createElement('div');
  btnRow.className = 'btn-row';

  const backBtn = document.createElement('button');
  backBtn.type = 'button';
  backBtn.className = 'secondary';
  backBtn.innerText = 'Back';
  backBtn.onclick = function() { showScreen(screenIndex - 1); };
  btnRow.appendChild(backBtn);

  const nextBtn = document.createElement('button');
  nextBtn.type = 'button';
  nextBtn.innerText = 'Next';
  nextBtn.onclick = function() { nextScreen(); };
  btnRow.appendChild(nextBtn);

  screenDiv.appendChild(btnRow);

  form.appendChild(screenDiv);
}

function createChoiceScreen() {
  const form = document.getElementById('surveyForm');
  const screenIndex = ++totalScreens;
  const screenDiv = document.createElement('div');
  screenDiv.className = 'survey-screen hidden';
  screenDiv.id = 'screen-' + screenIndex;
  screenDiv.setAttribute('data-screen-index', screenIndex);

  const h = document.createElement('h2');
  h.innerText = 'Behavioural Choice Task';
  screenDiv.appendChild(h);

  const content = document.createElement('div');
  content.className = 'survey-content';
  const p = document.createElement('p');
  // made the requested portion bold
  p.innerHTML = 'You have <strong>R500 to save for 30 days</strong>. Where would you prefer to keep it?';
  content.appendChild(p);

  const opts = [
    'Bank account',
    'Stokvel or trusted peer',
    'Mashonisa',
    'Cash at home'
  ];
  const listDiv = document.createElement('div');
  listDiv.className = 'multi-select-list';
  opts.forEach((opt,i) => {
    const lab = document.createElement('label');
    const radio = document.createElement('input');
    radio.type = 'radio';
    radio.name = 'choiceTask';
    radio.value = opt;
    if (i === 0) radio.required = true;
    lab.appendChild(radio);
    lab.appendChild(document.createTextNode(' ' + opt));
    listDiv.appendChild(lab);
  });
  content.appendChild(listDiv);

  screenDiv.appendChild(content);

  const btnRow = document.createElement('div');
  btnRow.className = 'btn-row';

  const backBtn = document.createElement('button');
  backBtn.type = 'button';
  backBtn.className = 'secondary';
  backBtn.innerText = 'Back';
  backBtn.onclick = function() { showScreen(screenIndex - 1); };
  btnRow.appendChild(backBtn);

  const nextBtn = document.createElement('button');
  nextBtn.type = 'button';
  nextBtn.innerText = 'Next';
  nextBtn.onclick = function() { nextScreen(); };
  btnRow.appendChild(nextBtn);

  screenDiv.appendChild(btnRow);

  form.appendChild(screenDiv);
}

function createDemographicsScreen() {
  const form = document.getElementById('surveyForm');
  const screenIndex = ++totalScreens;
  const screenDiv = document.createElement('div');
  screenDiv.className = 'survey-screen hidden';
  screenDiv.id = 'screen-' + screenIndex;
  screenDiv.setAttribute('data-screen-index', screenIndex);

  const h = document.createElement('h2');
  h.innerText = 'Demographics';
  screenDiv.appendChild(h);

  const content = document.createElement('div');
  content.className = 'survey-content';

  const genderLabel = document.createElement('label');
  genderLabel.innerText = 'Gender';
  content.appendChild(genderLabel);
  const genderDiv = document.createElement('div');
  genderDiv.className = 'multi-select-list';
  ['Female','Male','Other','Prefer not to say'].forEach((g,i) => {
    const lab = document.createElement('label');
    const radio = document.createElement('input');
    radio.type = 'radio';
    radio.name = 'gender';
    radio.value = g;
    if (i === 0) radio.required = true;
    lab.appendChild(radio);
    lab.appendChild(document.createTextNode(' ' + g));
    genderDiv.appendChild(lab);
  });
  content.appendChild(genderDiv);

  const incomeLabel = document.createElement('label');
  incomeLabel.innerText = 'Income band (per month)';
  content.appendChild(incomeLabel);
  const incomeDiv = document.createElement('div');
  incomeDiv.className = 'multi-select-list';
  ['< R2 000','R2 000–R5 000','R5 000–R10 000','> R10 000'].forEach((inc,i) => {
    const lab = document.createElement('label');
    const radio = document.createElement('input');
    radio.type = 'radio';
    radio.name = 'incomeBand';
    radio.value = inc;
    if (i === 0) radio.required = true;
    lab.appendChild(radio);
    lab.appendChild(document.createTextNode(' ' + inc));
    incomeDiv.appendChild(lab);
  });
  content.appendChild(incomeDiv);

  screenDiv.appendChild(content);

  const btnRow = document.createElement('div');
  btnRow.className = 'btn-row';

  const backBtn = document.createElement('button');
  backBtn.type = 'button';
  backBtn.className = 'secondary';
  backBtn.innerText = 'Back';
  backBtn.onclick = function() { showScreen(screenIndex - 1); };
  btnRow.appendChild(backBtn);

  const nextBtn = document.createElement('button');
  nextBtn.type = 'button';
  nextBtn.innerText = 'Next';
  nextBtn.onclick = function() { finishAndProceedToDebrief(); };
  btnRow.appendChild(nextBtn);

  screenDiv.appendChild(btnRow);

  form.appendChild(screenDiv);
}

function createDebriefScreens() {
  const form = document.getElementById('surveyForm');

  // Debrief & Distress Check (end)
  const screenIndex1 = ++totalScreens;
  const screenDiv1 = document.createElement('div');
  screenDiv1.className = 'survey-screen hidden';
  screenDiv1.id = 'screen-' + screenIndex1;
  screenDiv1.setAttribute('data-screen-index', screenIndex1);

  const h1 = document.createElement('h2');
  h1.innerText = 'Debrief & Distress Check (end)';
  screenDiv1.appendChild(h1);

  const content1 = document.createElement('div');
  content1.className = 'survey-content';
  const p1 = document.createElement('p');
  p1.innerText = 'Did any part of the scenario make you uncomfortable?';
  content1.appendChild(p1);

  const listDiv = document.createElement('div');
  listDiv.className = 'multi-select-list';
  ['Yes','No'].forEach((opt,i) => {
    const lab = document.createElement('label');
    const radio = document.createElement('input');
    radio.type = 'radio';
    radio.name = 'distress';
    radio.value = opt;
    if (i === 0) radio.required = true;
    radio.addEventListener('change', function() {
      toggleDistressExplain(opt === 'Yes');
    });
    lab.appendChild(radio);
    lab.appendChild(document.createTextNode(' ' + opt));
    listDiv.appendChild(lab);
  });
  content1.appendChild(listDiv);

  const explainLabel = document.createElement('label');
  explainLabel.innerText = 'If yes, please briefly tell us which part:';
  explainLabel.id = 'explainLabel';
  explainLabel.className = 'hidden';
  content1.appendChild(explainLabel);

  const explainArea = document.createElement('textarea');
  explainArea.name = 'distressExplain';
  explainArea.id = 'distressExplain';
  explainArea.placeholder = 'Briefly describe which part made you uncomfortable...';
  explainArea.maxLength = 200;
  explainArea.className = 'hidden';
  content1.appendChild(explainArea);

  const supportLink = document.createElement('a');
  supportLink.href = 'https://www.sadag.org/';
  supportLink.target = '_blank';
  supportLink.className = 'support-link hidden';
  supportLink.id = 'supportLink';
  supportLink.innerText = 'Support resources: South African Depression & Anxiety Group';
  content1.appendChild(supportLink);

  screenDiv1.appendChild(content1);

  const btnRow1 = document.createElement('div');
  btnRow1.className = 'btn-row';

  const backBtn1 = document.createElement('button');
  backBtn1.type = 'button';
  backBtn1.className = 'secondary';
  backBtn1.innerText = 'Back';
  backBtn1.onclick = function() { showScreen(screenIndex1 - 1); };
  btnRow1.appendChild(backBtn1);

  const nextBtn1 = document.createElement('button');
  nextBtn1.type = 'button';
  nextBtn1.innerText = 'Next';
  nextBtn1.onclick = function() {
    if (!document.querySelector('input[name="distress"]:checked')) {
      alert('Please answer whether any part made you uncomfortable.');
      return;
    }
    const sel = document.querySelector('input[name="distress"]:checked').value;
    if (sel === 'Yes') {
      const txt = document.getElementById('distressExplain').value.trim();
      if (!txt) {
        alert('You selected Yes. Please briefly indicate which part made you uncomfortable.');
        return;
      }
    }
    nextScreen();
  };
  btnRow1.appendChild(nextBtn1);

  screenDiv1.appendChild(btnRow1);
  form.appendChild(screenDiv1);

  // Debrief text (short)
  const screenIndex2 = ++totalScreens;
  const screenDiv2 = document.createElement('div');
  screenDiv2.className = 'survey-screen hidden';
  screenDiv2.id = 'screen-' + screenIndex2;
  screenDiv2.setAttribute('data-screen-index', screenIndex2);

  const h2 = document.createElement('h2');
  h2.innerText = 'Debrief';
  screenDiv2.appendChild(h2);

  const content2 = document.createElement('div');
  content2.className = 'survey-content';
  const p2a = document.createElement('p');
  p2a.innerText = 'Earlier, you read a short scenario about managing on a tight budget and answered questions about different ways to keep your money safe.';
  content2.appendChild(p2a);
  const p2b = document.createElement('p');
  p2b.innerText = 'These questions help us understand how financial stress can influence decision-making and explore ideas that could make managing money easier. Your responses are completely confiden[...]';
  content2.appendChild(p2b);

  screenDiv2.appendChild(content2);

  const btnRow2 = document.createElement('div');
  btnRow2.className = 'btn-row';

  const backBtn2 = document.createElement('button');
  backBtn2.type = 'button';
  backBtn2.className = 'secondary';
  backBtn2.innerText = 'Back';
  backBtn2.onclick = function() { showScreen(screenIndex2 - 1); };
  btnRow2.appendChild(backBtn2);

  const submitBtn = document.createElement('button');
  submitBtn.type = 'button';
  submitBtn.innerText = 'Finish and submit';
  submitBtn.onclick = function() { submitSurvey(true); };
  btnRow2.appendChild(submitBtn);

  screenDiv2.appendChild(btnRow2);
  form.appendChild(screenDiv2);
}

function createThankYouScreen() {
  const form = document.getElementById('surveyForm');
  const screenIndex = ++totalScreens;
  const screenDiv = document.createElement('div');
  screenDiv.className = 'survey-screen hidden';
  screenDiv.id = 'screen-' + screenIndex;
  screenDiv.setAttribute('data-screen-index', screenIndex);

  const h = document.createElement('h2');
  h.innerText = 'End of Survey';
  screenDiv.appendChild(h);

  const content = document.createElement('div');
  content.className = 'survey-content';
  const p = document.createElement('p');
  p.innerText = 'Thank you for completing the study! Your answers have been submitted.';
  content.appendChild(p);
  screenDiv.appendChild(content);

  form.appendChild(screenDiv);
}

function buildAllScreens() {
  // insert qualifying screen immediately after the intro (screen-1)
  createQualifyingScreen();
  createStatementScreens();
  createScarcityScreen();
  createChoiceScreen();
  createDemographicsScreen();
  createDebriefScreens();
  createThankYouScreen();
}

function showScreen(n) {
  document.querySelectorAll('.survey-screen').forEach(el => el.classList.add('hidden'));
  const screen = document.getElementById('screen-' + n);
  if (screen) screen.classList.remove('hidden');
  const pct = Math.round((n / totalScreens) * 100);
  document.getElementById('progressBar').style.width = pct + '%';
  currentScreen = n;
  window.scrollTo(0,0);
}

function nextScreen() {
  const next = currentScreen + 1;
  if (next <= totalScreens) showScreen(next);
}

function exitSurvey() {
  document.getElementById('surveyForm').classList.add('hidden');
  document.getElementById('exitMsg').classList.remove('hidden');
}

function toggleDistressExplain(show) {
  const label = document.getElementById('explainLabel');
  const area = document.getElementById('distressExplain');
  const link = document.getElementById('supportLink');
  if (show) {
    label.classList.remove('hidden');
    area.classList.remove('hidden');
    link.classList.remove('hidden');
    area.required = true;
  } else {
    label.classList.add('hidden');
    area.classList.add('hidden');
    link.classList.add('hidden');
    area.required = false;
    area.value = '';
  }
}

function finishAndProceedToDebrief() {
  if (!document.querySelector('input[name="gender"]:checked') || !document.querySelector('input[name="incomeBand"]:checked')) {
    alert('Please complete the demographics questions.');
    return;
  }
  const idx = findScreenIndexByHeading('Debrief & Distress Check (end)');
  if (idx) showScreen(idx);
  else nextScreen();
}

function collectSurveyData() {
  const data = {};
  statements.forEach((stmt, idx) => {
    systems.forEach(sys => {
      const name = `q${idx+1}_${sys.key}`;
      const el = document.getElementById(name);
      data[name] = el ? el.value : '';
    });
  });
  const sp = document.querySelector('input[name="scarcityPrime"]:checked');
  data.scarcityPrime = sp ? sp.value : '';
  const choice = document.querySelector('input[name="choiceTask"]:checked');
  data.choiceTask = choice ? choice.value : '';
  const gender = document.querySelector('input[name="gender"]:checked');
  const income = document.querySelector('input[name="incomeBand"]:checked');
  data.gender = gender ? gender.value : '';
  data.incomeBand = income ? income.value : '';
  const distress = document.querySelector('input[name="distress"]:checked');
  data.distress = distress ? distress.value : '';
  data.distressExplain = document.getElementById('distressExplain') ? document.getElementById('distressExplain').value.trim() : '';
  // collect attention check answer
  const attn = document.querySelector('input[name="attentionCheck"]:checked');
  data.attentionCheck = attn ? attn.value : '';
  // collect qualifying answer if present
  const qual = document.querySelector('input[name="qualifySA"]:checked');
  data.qualifySA = qual ? qual.value : '';
  data.timestamp = new Date().toISOString();
  data.screenWhenSubmitted = currentScreen;
  return data;
}

function submitSurvey(final = true) {
  const data = collectSurveyData();
  if (!final) data.partial = true;

  // Debug log so you can inspect what is being sent in the Network console
  console.log('Submitting survey data to endpoint:', ENDPOINT_URL, data);

  fetch(ENDPOINT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams(data).toString()
  })
  .then(res => res.text().then(text => ({ ok: res.ok, status: res.status, text })))
  .then(({ ok, status, text }) => {
    console.log('Server response status:', status, 'body:', text);
    const thankIndex = totalScreens;
    showScreen(thankIndex);
    document.getElementById('surveyForm').classList.add('hidden');
    document.getElementById('exitMsg').classList.remove('hidden');
  })
  .catch(err => {
    console.error('Submission error', err);
    alert('There was a problem submitting your responses. Please check your internet connection or try again later.');
    const thankIndex = totalScreens;
    showScreen(thankIndex);
    document.getElementById('surveyForm').classList.add('hidden');
    document.getElementById('exitMsg').classList.remove('hidden');
  });
}

function findScreenIndexByHeading(text) {
  for (let i=1;i<=totalScreens;i++) {
    const el = document.getElementById('screen-' + i);
    if (!el) continue;
    const h = el.querySelector('h2, h1');
    if (h && h.innerText.trim().startsWith(text)) return i;
  }
  return null;
}

function submitPartialSurveyOnExit() {
  const data = collectSurveyData();
  data.partial = true;
  data.screenWhenExited = currentScreen;
  if (currentScreen > 1 && navigator.sendBeacon) {
    const body = new URLSearchParams(data).toString();
    const blob = new Blob([body], { type: "application/x-www-form-urlencoded" });
    navigator.sendBeacon(ENDPOINT_URL, blob);
  }
}

window.addEventListener("beforeunload", submitPartialSurveyOnExit);

document.addEventListener('DOMContentLoaded', function() {
  buildAllScreens();
  showScreen(1);
});
</script>

</body>
</html>
